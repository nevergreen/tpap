/*! caja-kissy 2013-09-23 */
KISSY.add("init-countdown-widgets",function(t){function n(n,e){var r=this;cfg={timeBegin:0,collateurl:"",collateval:0},r.timeStart=new Date,r.config=t.merge(cfg,e||{}),r._countTime(n)}function e(n,r,i){var o={d:".ks-d",h:".ks-h",m:".ks-m",s:".ks-s",i:".ks-i"},a={interval:1e3,timeUnitCls:o,minDigit:2,timeRunCls:".ks-countdown-run",timeEndCls:".ks-countdown-end"},s=t.merge(a,i);s.run&&!t.isFunction(s.run)&&delete s.run,s.end&&!t.isFunction(s.end)&&delete s.end,s.interval=parseInt(s.interval),(isNaN(s.interval)||200>s.interval)&&(s.interval=200),e.superclass.constructor.call(this,r,s),this.counter(n)}function r(n,e){var r=function(n){t.isDate(n)||(n=new Date),t.isFunction(e)&&e(n)};t.io({url:n,type:"HEAD",success:function(t,n,e){r(new Date(e.getResponseHeader("date")))},error:function(){r(new Date)},cache:!1})}function r(n,e){function r(t,n){1e3>t?e(n):3>o?i():e(new Date(n.setMilliseconds(n.getMilliseconds()+t/2)))}function i(){var e=new Date;o++,t.io({url:n,type:"HEAD",success:function(t,n,i){r(new Date-e,new Date(i.getResponseHeader("date")))},error:function(){r()},cache:!1})}var o=0;i()}function i(n,e,i){n="."+(n||"J_TWidget");var a=function(r){t.query(n,e).each(function(n){var e=o.attr(n,"data-widget-type"),i=o.attr(n,"data-widget-config");"Countdown"===e&&(i=t.isNull(i)?{}:JSON.parse(i.replace(/'/g,'"')),r&&t.isDate(r)&&(i.timeBegin=r),new t.Countdown(n,i.endTime,i))})};i?r(i,a):a()}var o=t.DOM,a={d:864e5,h:36e5,m:6e4,s:1e3,i:1},s=["d","h","m","s","i"];return n.prototype={_countTime:function(n){var e=this,r=e.config,i=r.timeBegin,o=0;if(/^(\d{4})\-(\d{1,2})\-(\d{1,2})(\s+)(\d{1,2}):(\d{1,2}):(\d{1,2})$/gi.test(n.replace(/\./g,"-"))){var a=n.match(/\d+/g);n=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5])}else/^\d+&/.test(n)&&(n=parseInt(n));o=t.isNull(i)||isNaN(i)||0>=i?t.isDate(n)?n-new Date:parseInt(n):typeof i==typeof n?n-i:0,(!t.isNumber(o)||0>o)&&(o=0),e.timeRemain=o},getRemain:function(){var t=parseInt(this.timeRemain-(new Date-this.timeStart));return isNaN(t)||0>=t?0:t},format:function(n){var e=Array.prototype.slice.call(arguments,1),r=[];return t.each(e,function(t){if(a[t]){var e=Math.floor(n/a[t]);n-=e*a[t],r.push(e)}}),r},fetch:function(t,n,e){var r=this,i=setInterval(function(){var t=r.getRemain();t>0?n&&n.call(r,t):(n&&n.call(r,0),e&&e.call(r),clearInterval(i))},t)}},t.extend(e,n,{counter:function(n){var e=this,r=e.config,i=function(n){var i=[n].concat(d),o=e.format.apply(this,i);t.each(l,function(t,n){t.text(o[n])}),r.run&&r.run.call(e,i,o)},o=function(){u.hide(),c.show(),r.end&&r.end.call(e)},a=r.timeUnitCls,n=t.one(n),u=n.all(r.timeRunCls),c=n.all(r.timeEndCls),l=[],d=[];t.each(s,function(t){a[t]&&n.one(a[t])&&(l.push(n.one(a[t])),d.push(t))}),u.show(),c.hide(),e.fetch(r.interval,i,o)}}),e.autoRender=i,e.Core=n,e.getServerTime=r,t.Countdown=e,e}),KISSY.use("switchable, init-countdown-widgets",function(t,n,e){function r(r,i){function o(){t.later(function(){if(0!==u.length){try{a(u.shift())}catch(n){t.log("\u521d\u59cb\u5316\u7ec4\u4ef6\u51fa\u9519")}o()}},0)}function a(r){var i,o=r.getAttribute("data-widget-type");if(o)try{switch(i=r.getAttribute("data-widget-config"),i&&(i=i.replace(/'/g,'"')),i=t.JSON.parse(i),!0){case s.switchable.indexOf(o)>-1:new n(r,i);break;case s.countdown.indexOf(o)>-1:new e(r,i.endTime,i);break;default:t.log("\u5728kissy\u5e93\u4e2d\u6ca1\u6709\u67e5\u627e\u5230\u4f60\u60f3\u8981\u521d\u59cb\u5316\u7684\u7ec4\u4ef6")}}catch(a){t.log("widget "+a,"warn")}}r="."+(r||"KS_Widget");var s={switchable:"Tabs Slide Carousel Accordion",overlay:"Popup",countdown:"Countdown"},u=t.query(r,i);o()}var i=t.DOM,o="J_TScriptedModule";KISSY.each(i.query("."+o),function(t){r("J_TWidget",t)})});